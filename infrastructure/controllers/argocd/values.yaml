configs:
  cm:
    create: true
    application.resourceTrackingMethod: "annotation+label"
  
  cmp:
    create: true
    plugins:
      plugin.yaml:
        apiVersion: argoproj.io/v1alpha1
        kind: ConfigManagementPlugin
        metadata:
          name: kustomize-build-with-helm
        spec:
          version: v1.0
          # Discover phase - tells ArgoCD when to use this plugin
          discover:
            find:
              command: [sh, -c]
              args:
                - |
                  if [ -f "kustomization.yaml" ] || [ -f "kustomization.yml" ]; then
                    echo "kustomization file found"
                  fi
          # Init phase - prepare Helm dependencies
          init:
            command: [sh, -c]
            args:
              - |
                if [ -f "Chart.yaml" ] || [ -f "requirements.yaml" ]; then
                  echo "Found Helm chart, building dependencies..."
                  helm dependency build
                fi
          # Generate phase - create final manifests
          generate:
            command: [sh, -c]
            args:
              - |
                if [ -f "kustomization.yaml" ] || [ -f "kustomization.yml" ]; then
                  echo "Running kustomize build with helm support..."
                  kustomize build --enable-helm .
                else
                  echo "ERROR: No kustomization file found"
                  exit 1
                fi
  
  params:
    server.insecure: true

crds:
  install: true
  # Keep CRDs on chart uninstall
  keep: false

controller:
  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      cpu: 500m
      memory: 256Mi

dex:
  resources:
    requests:
      cpu: 20m
      memory: 32Mi
    limits:
      cpu: 200m
      memory: 64Mi

redis:
  resources:
    requests:
      cpu: 50m
      memory: 32Mi
    limits:
      cpu: 200m
      memory: 64Mi

server:
  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      cpu: 500m
      memory: 128Mi

repoServer:
  containerSecurityContext:
    readOnlyRootFilesystem: true
  
  volumes:
    - name: cmp-kustomize-build-with-helm
      configMap:
        name: argocd-cmp-cm
    - name: cmp-tmp
      emptyDir: {}
  
  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      cpu: 500m
      memory: 256Mi
  
  extraContainers:
    - name: kustomize-build-with-helm
      command:
        - argocd-cmp-server
      image: '{{ default .Values.global.image.repository .Values.repoServer.image.repository }}:{{ default (include "argo-cd.defaultTag" .) .Values.repoServer.image.tag }}'
      securityContext:
        runAsNonRoot: true
        runAsUser: 999
        allowPrivilegeEscalation: false
        readOnlyRootFilesystem: true
        seccompProfile:
          type: RuntimeDefault
        capabilities:
          drop: ["ALL"]
      volumeMounts:
        - name: plugins
          mountPath: /home/argocd/cmp-server/plugins
        - name: cmp-kustomize-build-with-helm
          mountPath: /home/argocd/cmp-server/config/
          # subPath removed to avoid "is a directory" error
        - mountPath: /tmp
          name: cmp-tmp

applicationSet:
  resources:
    requests:
      cpu: 50m
      memory: 32Mi
    limits:
      cpu: 200m
      memory: 128Mi

notifications:
  enabled: false
  resources:
    requests:
      cpu: 20m
      memory: 32Mi
    limits:
      cpu: 100m
      memory: 64Mi
